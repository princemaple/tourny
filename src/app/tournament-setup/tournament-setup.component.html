<div class="min-w-[360px] flex flex-col items-stretch px-4">
  <header
    class="flex justify-between items-center mb-4 sticky top-0 z-10 bg-white/[0.85] -mx-4 px-2"
  >
    <a mat-icon-button routerLink="/dashboard">
      <mat-icon>arrow_back</mat-icon>
    </a>

    <h3>
      {{ tournament?.name }}
      <a mat-icon-button routerLink="/tournaments/{{ tournament?.id }}/edit">
        <mat-icon fontIcon="edit"></mat-icon>
      </a>
    </h3>

    <mat-icon
      *ngIf="loading.count | async as c; else check"
      class="animate-spin"
      fontIcon="sync"
    ></mat-icon>
    <ng-template #check><mat-icon fontIcon="check_circle"></mat-icon></ng-template>
  </header>

  <section>
    <span>{{ tournament?.start_at | date }}</span>
    <span *ngIf="tournament?.end_at"> - {{ tournament?.end_at | date }}</span>

    <pre class="whitespace-pre-wrap">{{ tournament?.description }}</pre>
  </section>

  <section class="flex flex-col">
    <h4>Tournament Participants</h4>

    <div class="text-slate-500 rounded bg-gray-100 p-4">
      A participant is, for example, a "team" in basketball 5v5 / 3v3 tournament, a "player" in solo
      tennis tournament.
    </div>

    <h5>Participants</h5>

    <mat-chip-list
      class="mb-4"
      *ngIf="tournament?.participants?.length"
      aria-label="participant list"
      [ngModel]="tournament!.participants"
      name="participants"
      required
    >
      <mat-chip *ngFor="let p of tournament?.participants" (removed)="removeParticipant(p)">
        {{ p.name }}
        <button matChipRemove>
          <mat-icon>cancel</mat-icon>
        </button>
      </mat-chip>
    </mat-chip-list>

    <div class="flex gap-4 justify-center">
      <button mat-button color="primary" type="button" (click)="addParticipant()">
        Add Participant
      </button>

      <button mat-button color="primary" type="button" (click)="loadParticipants()">
        Load Participants
      </button>
    </div>
  </section>

  <h4>Tournament Stages</h4>

  <ng-container *ngFor="let s of tournament?.stages; index as i">
    <mat-card class="mb-4" cdkDropListGroup>
      <mat-card-title>{{ s.name }}</mat-card-title>
      <mat-card-subtitle>
        <span>{{ s.type | apply: casing }}</span>
        <span *ngIf="s.groups.length as count">, Group count: {{ count }}</span>
      </mat-card-subtitle>
      <mat-card-content class="!flex gap-4">
        <div
          class="p-4 min-w-[20px] bg-slate-200 rounded"
          *ngFor="let g of s.groups"
          cdkDropList
          [cdkDropListData]="g"
          (cdkDropListDropped)="changeGroup($event, s)"
        >
          <h4 class="m-0">Group {{ g.order | apply: groupName }}</h4>

          <ul class="list-none p-0 mb-0">
            <li
              *ngFor="let p of g.participants"
              cdkDrag
              [cdkDragData]="p"
              class="flex items-center mb-1"
            >
              <mat-icon cdkDragHandle fontIcon="drag_handle" class="cursor-move text-sm"></mat-icon>
              <span>{{ p.name }}</span>
              <span *cdkDragPreview class="block py-1 px-2 bg-slate-300 rounded">{{ p.name }}</span>
            </li>
          </ul>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button mat-button color="primary" (click)="addGroup(s)">Add Group</button>
        <button
          *ngIf="s.groups.length && i === 0"
          mat-button
          color="primary"
          (click)="fillParticipants(s)"
        >
          Fill participants
        </button>
        <button mat-button (click)="resetParticipants(s)">Remove Participants</button>
        <button mat-button (click)="dropGroup(s)">Drop a group</button>
        <button mat-button (click)="genMatches(s)">GEN</button>
      </mat-card-actions>
    </mat-card>

    <div class="flex flex-wrap gap-4 mb-4">
      <div class="p-4 min-w-[20px] bg-slate-200 rounded" *ngFor="let m of s.matches">
        <span *ngIf="m.left; else tbd">
          {{ m.left.name }}<span *ngIf="m.right; else bye"> vs {{ m.right.name }}</span>
        </span>
        <ng-template #bye> gets a BYE!</ng-template>
        <ng-template #tbd>TBD</ng-template>
      </div>
    </div>
  </ng-container>
</div>
